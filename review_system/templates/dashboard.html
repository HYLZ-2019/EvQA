<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Dashboard - Event Video Annotation System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Dataset Dashboard</h1>
            <div class="header-controls">
                <a href="/" class="nav-button">Back to Annotation</a>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- Loading Section -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Loading dashboard data...</p>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-cards" id="statsCards" style="display: none;">
                <div class="stat-card">
                    <h3>Total Questions</h3>
                    <div class="stat-number" id="totalQuestions">0</div>
                </div>
                <div class="stat-card">
                    <h3>Datasets</h3>
                    <div class="stat-number" id="totalDatasets">0</div>
                </div>
                <div class="stat-card">
                    <h3>Annotators</h3>
                    <div class="stat-number" id="totalAnnotators">0</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section" id="chartsSection" style="display: none;">
                <!-- First Row of Charts -->
                <div class="chart-row">
                    <div class="chart-container">
                        <h3>Questions by Dataset</h3>
                        <canvas id="datasetChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Questions by Annotator</h3>
                        <canvas id="annotatorChart"></canvas>
                    </div>
                </div>

                <!-- Second Row of Charts -->
                <div class="chart-row">
                    <div class="chart-container">
                        <h3>Content Type Distribution</h3>
                        <canvas id="contentTypeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Question Type Distribution</h3>
                        <canvas id="questionTypeChart"></canvas>
                    </div>
                </div>

                <!-- Third Row of Charts -->
                <div class="chart-row">
                    <div class="chart-container">
                        <h3>Camera Type Distribution</h3>
                        <canvas id="cameraTypeChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Duration Distribution</h3>
                        <canvas id="durationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Tables -->
            <div class="tables-section" id="tablesSection" style="display: none;">
                <div class="table-container">
                    <h3>Dataset Details</h3>
                    <table id="datasetTable">
                        <thead>
                            <tr>
                                <th>Dataset Name</th>
                                <th>Description</th>
                                <th>Annotator</th>
                                <th>Question Count</th>
                            </tr>
                        </thead>
                        <tbody id="datasetTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let charts = {};

        // Load dashboard data on page load
        window.addEventListener('load', function() {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard_stats');
                dashboardData = await response.json();
                
                if (dashboardData.error) {
                    throw new Error(dashboardData.error);
                }

                displayStatistics();
                createCharts();
                createTables();
                
                // Hide loading and show content
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('statsCards').style.display = 'grid';
                document.getElementById('chartsSection').style.display = 'block';
                document.getElementById('tablesSection').style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loadingSection').innerHTML = 
                    '<p style="color: red;">Error loading dashboard data: ' + error.message + '</p>';
            }
        }

        function displayStatistics() {
            document.getElementById('totalQuestions').textContent = dashboardData.total_questions;
            document.getElementById('totalDatasets').textContent = dashboardData.total_datasets;
            document.getElementById('totalAnnotators').textContent = Object.keys(dashboardData.annotator_distribution).length;
        }

        function createCharts() {
            // Color palette for charts
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];

            // Dataset distribution chart
            createPieChart('datasetChart', 'Questions by Dataset', dashboardData.dataset_distribution, colors);

            // Annotator distribution chart
            createPieChart('annotatorChart', 'Questions by Annotator', dashboardData.annotator_distribution, colors);

            // Content type distribution chart
            createPieChart('contentTypeChart', 'Content Type Distribution', dashboardData.content_type_distribution, colors);

            // Question type distribution chart
            createPieChart('questionTypeChart', 'Question Type Distribution', dashboardData.question_type_distribution, colors);

            // Camera type distribution chart
            createPieChart('cameraTypeChart', 'Camera Type Distribution', dashboardData.camera_type_distribution, colors);

            // Duration distribution chart (bar chart)
            createBarChart('durationChart', 'Duration Distribution', dashboardData.duration_distribution);
        }

        function createPieChart(canvasId, title, data, colors) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = Object.keys(data);
            const values = Object.values(data);

            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(canvasId, title, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const labels = data.bin_names;
            const values = data.counts;

            charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                label: 'Number of Questions',
                data: values,
                backgroundColor: '#36A2EB',
                borderColor: '#36A2EB',
                borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                legend: {
                    display: false
                }
                },
                scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                    stepSize: 1
                    }
                }
                }
            }
            });
        }

        function createTables() {
            const tableBody = document.getElementById('datasetTableBody');
            tableBody.innerHTML = '';

            dashboardData.datasets.forEach(dataset => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dataset.dataset_name}</td>
                    <td>${dataset.description || 'N/A'}</td>
                    <td>${dataset.annotator || 'N/A'}</td>
                    <td>${dataset.question_count}</td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>
